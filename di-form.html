<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-signals/core-signals.html">


<polymer-element name="di-form" on-keypress="{{keypressHandler}}">
  <template>
    <form id={{id}}>
      <content></content>
    </form>
    <core-signals on-core-signal-submit="{{submitHandler}}"></core-signals>
  </template>

  <script>
    // XXX: Firefox and Safari choke when native DOM attributes
    // are published using the attributes attribute on the polymer-element.
    // Workaround is to publish here instead.
    Polymer({
      publish: {
        id: null,
        valid: false
      },

      ready: function() {
        var inputs = this.getInputs();

        [].forEach.call(inputs, function(el, i) {
          el.addEventListener('change', function(ev) {
            this.checkValidity();
          });
        });

      },

      submit: function() {
        var _this = this;

        // Get all paper inputs within this di-form
        var inputs = this.getInputs();

        // Set di-form's valid state
        _this.valid = true;
        [].forEach.call(inputs, function(el, i) {
          if (!el.checkValidity()) {
            _this.valid = false;
          }
        });

        // Fire the submit event
        this.fire('submit', this);
      },

      keypressHandler: function(e) {
        if (e.which === 13){
          // Set validity before firing submit event
          this.submit();
        }
      },

      subitHandler: function(e, detail, sender) {
        console.log(e, detail, sender);
        this.submit();
      },

      getInputs: function(){
        return this.querySelectorAll('paper-inputs');
      }
    });
  </script>
</polymer-element>
